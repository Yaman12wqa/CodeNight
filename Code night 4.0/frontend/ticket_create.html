<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Ticket Olustur | CampuSupport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0f172a; color:#e2e8f0; display:flex; justify-content:center; align-items:center; min-height:100vh; }
    .card { background:#111827; padding:22px; border-radius:14px; width:380px; box-shadow:0 12px 30px rgba(0,0,0,0.35); }
    h1 { margin-top:0; }
    label { display:block; font-size:13px; margin-bottom:6px; color:#cbd5e1; }
    input, select, textarea, button { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:#0b1220; color:#e2e8f0; margin-bottom:12px; }
    textarea { min-height:90px; resize:vertical; }
    button { background: linear-gradient(135deg,#22d3ee,#6366f1); border:none; font-weight:600; cursor:pointer; }
    a { color:#38bdf8; text-decoration:none; }
    .row { display:flex; gap:10px; justify-content:space-between; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ticket Olustur</h1>
    <div class="row">
      <small>Token durum: <span id="authStatus">Yok</span></small>
      <a href="/frontend/auth.html">Auth sayfasi</a>
    </div>
    <label for="title">Baslik</label>
    <input id="title" placeholder="Wi-Fi cekmiyor">
    <label for="department">Departman</label>
    <select id="department"></select>
    <label for="priority">Oncelik</label>
    <select id="priority">
      <option value="low">Dusuk</option>
      <option value="medium" selected>Orta</option>
      <option value="high">Yuksek</option>
    </select>
    <label for="description">Aciklama</label>
    <textarea id="description" placeholder="Sorunu detaylandir..."></textarea>
    <button onclick="createTicket()">Ticket ac</button>
    <div class="row">
      <a href="/frontend/tickets_list.html">Ticket'larim</a>
      <a href="/frontend/department.html">Departman gorunumu</a>
      <a href="/frontend/ticket_detail.html">Ticket detay</a>
    </div>
    <small id="toast"></small>
  </div>

  <script>
    const api = "http://127.0.0.1:8000";
    let token = localStorage.getItem("campusToken") || "";
    const authStatus = document.getElementById("authStatus");
    const toast = document.getElementById("toast");
    function show(msg, err=false){ toast.textContent = msg; toast.style.color = err ? "#f87171" : "#22c55e"; }
    function authHeaders(){ return token ? { "Authorization": `Bearer ${token}` } : {}; }
    authStatus.textContent = token ? "Hazir" : "Yok (giris yap)";

    async function loadDepartments(){
      const res = await fetch(`${api}/departments`);
      const opts = await res.json();
      const sel = document.getElementById("department");
      sel.innerHTML = "";
      opts.forEach(o=>{ const el=document.createElement("option"); el.value=o.id; el.textContent=o.name; sel.appendChild(el); });
    }

    async function createTicket(){
      if (!token){ show("Giris yapiniz", true); return; }
      const payload = {
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        department_id: Number(document.getElementById("department").value),
        priority: document.getElementById("priority").value
      };
      const res = await fetch(`${api}/tickets`, { method:"POST", headers:{ "Content-Type":"application/json", ...authHeaders() }, body: JSON.stringify(payload) });
      if (!res.ok){ const txt = await res.text(); show(`Basarisiz (${res.status})`, true); console.error(txt); return; }
      show("Ticket acildi");
    }

    loadDepartments();
  </script>
</body>
</html>
